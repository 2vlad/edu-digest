{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-newspaper"></i> Накопленные новости</h1>
    <div>
        {% if grouped_news %}
        <form method="POST" action="{{ url_for('publish_digest') }}" class="d-inline">
            <button type="submit" class="btn btn-success" onclick="return confirm('Опубликовать дайджест сейчас?')">
                <i class="fas fa-paper-plane"></i> Опубликовать дайджест
            </button>
        </form>
        {% endif %}
        <a href="{{ url_for('run_collect') }}" class="btn btn-primary">
            <i class="fas fa-sync-alt"></i> Собрать новости
        </a>
    </div>
</div>

{% if not grouped_news %}
<div class="alert alert-info">
    <i class="fas fa-info-circle"></i> Нет накопленных новостей. Запустите сбор новостей для накопления.
</div>

<!-- Кнопка создания таблицы если она отсутствует -->
<div class="alert alert-warning">
    <h6><i class="fas fa-exclamation-triangle"></i> Таблица pending_news отсутствует</h6>
    <p>Если вы видите ошибки "relation does not exist", нужно создать таблицу:</p>
    <form method="POST" action="{{ url_for('create_pending_table') }}" class="d-inline">
        <button type="submit" class="btn btn-warning" onclick="return confirm('Создать таблицу pending_news?')">
            <i class="fas fa-plus"></i> Создать таблицу pending_news
        </button>
    </form>
</div>
{% else %}
    {% for group_key, news_list in grouped_news.items() %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-calendar"></i> {{ group_key }}
                <span class="badge bg-primary">{{ news_list|length }} новостей</span>
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th width="40%">Суммаризация</th>
                            <th width="20%">Канал</th>
                            <th width="15%">Релевантность</th>
                            <th width="15%">Время сбора</th>
                            <th width="10%">Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for news in news_list %}
                        <tr id="news-{{ news.id }}">
                            <td>
                                <div class="text-truncate" style="max-width: 400px;" title="{{ news.summary }}">
                                    {{ news.summary }}
                                </div>
                                <details class="mt-1">
                                    <summary class="text-muted small">Полный текст</summary>
                                    <div class="mt-2 p-2 bg-light rounded small">
                                        {{ news.message_text|truncate(500) }}
                                    </div>
                                </details>
                            </td>
                            <td>
                                {% set clean_channel = news.channel_name.lstrip('@') %}
                                {% if news.message_id %}
                                    <a href="https://t.me/{{ clean_channel }}/{{ news.message_id }}" 
                                       target="_blank" class="badge bg-secondary text-decoration-none">
                                        {{ news.channel_name }}
                                    </a>
                                {% else %}
                                    <a href="https://t.me/{{ clean_channel }}" 
                                       target="_blank" class="badge bg-secondary text-decoration-none">
                                        {{ news.channel_name }}
                                    </a>
                                {% endif %}
                            </td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar 
                                        {% if news.relevance_score >= 8 %}bg-success
                                        {% elif news.relevance_score >= 5 %}bg-warning
                                        {% else %}bg-danger{% endif %}" 
                                        style="width: {{ news.relevance_score * 10 }}%">
                                        {{ news.relevance_score }}/10
                                    </div>
                                </div>
                            </td>
                            <td>
                                <small>{{ news.collected_at[:16] if news.collected_at else 'N/A' }}</small>
                            </td>
                            <td>
                                <form method="POST" action="{{ url_for('delete_pending_news', news_id=news.id) }}" 
                                      class="d-inline" onsubmit="return confirmDelete()">
                                    <button type="submit" class="btn btn-sm btn-danger" title="Удалить из дайджеста">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endfor %}
{% endif %}

<div class="card mt-4">
    <div class="card-header">
        <h6><i class="fas fa-info-circle"></i> Информация</h6>
    </div>
    <div class="card-body">
        <p class="mb-1"><strong>Автоматический сбор:</strong> каждый час</p>
        <p class="mb-1"><strong>Автоматическая публикация:</strong> 12:00 и 18:00</p>
        <p class="mb-0"><strong>Максимум новостей в дайджесте:</strong> 7</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function confirmDelete() {
    return confirm('Удалить эту новость из будущего дайджеста?');
}

// Автообновление страницы каждые 30 секунд
setInterval(function() {
    if (!document.hidden) {
        location.reload();
    }
}, 30000);
</script>
{% endblock %}